# 结题报告

## 目录

## 项目介绍

本项目名为 **GraND Pro**，全称为 Graph Network Disk with Prometheus，带有图结构的分布式网盘，加有监控运维模块。

本项目基于 2021 年的 x-DisGraFS 展开，DisGraFS 是一个分布式图文件系统，它将图结构的思想应用到分布式文件系统上面，使之兼具图文件系统方便用户快速搜索、模糊搜索、查找相关文件的特点，以及分布式文件系统的海量文件存储、云存储的特点。不过，DisGraFS 并未实现真正的远程存储集群，它要求用户将存储节点挂载到本地，形成一个客户端，这一操作增加了用户的使用难度。我们项目参考了 2020 年 dontpanic 的高可用性分布式存储设计，搭建起完全意义上的存储集群，简化用户操作，用户对文件的上传、下载、共享等操作只需在网页端进行，无需额外配置。 此外，我们致力于设计一套带有监控模块的可运维系统，通过监控，运维工作者能够实时掌握系统的运行状态，保证服务正确稳定地运行，并且可以远程执行管理员操作。

在具体实现上，我们复用了 dontpanic 的纠删码文件切片设计，改进了多用户隔离，在网页端引入共享、删除、重命名等文件操作，引入了文件夹操作，通过 vpn 搭建 Ray 集群，引入了监控模块，监控数据图形可视化，运维工作者可以远程唤醒或关闭存储节点。用户的所有操作均在网页端进行。我们也实现了多个模块的容器化部署。

## 小组成员以及分工

- 徐奥（组长）：计算集群，Websockets
- 关浩祥：
- 牛午甲：
- 谭骏飞：
- 赵子毅：

此外，对 DisGraFS 和 dontpanic 的源码阅读与复现均由五名成员合作完成

## 立项依据

### 项目背景



### DisGraFS

DisGraFS 是由 [OSH-2021 x-DisGraFS 小组](https://github.com/OSH-2021/x-DisGraFS) 构建地一个分布式图文件系统，将图结构的思想应用于分布式文件系统上面，使其兼顾图文件系统方便用户快速搜索、模糊搜索、查找相关文件的特点，以及分布式文件系统的海量文件存储、云存储的特点。

#### DisGraFS 中存在的问题

1. DisGraFS 的远程存储集群实际没有实现。按照 DisGraFS 本来的设想，当整个分布式文件系统搭建运行起来以后，用户只需要进入到 DisGraFS 提供的网页，登陆验证通过后，即可看到整个图文件系统，并在网页上实现文件的上传、移动和删除。而 DisGraFS 在具体实现中，为了简化工作量（工作量确实非常大），DisGraFS 小组将远程存储节点进行了简化，远程存储集群的 Redis 数据库仅有一台服务器，而用户需要将这个存储集群挂载到本地，才能实现文件的传输。我们致力于完成他们最初的设想，重新搭建存储集群，这将是一个真正具有多个存储节点的、远程的集群，用户的所有操作仅需要在网页端执行。
2. DisGraFS 并不具备可运维性，也没有进行可用性的保障，它的日志文件分散，开发人员很难同时获得整个系统的运行状态，也很难看到各个节点的资源使用情况，甚至无法及时了解某个物理节点是否还处于连接状态，这使得它的可用性不能得到保证。这也是我们要搭建监控组件的原因。

### dontpanic

#### 文件编解码

dontpanic 采用纠删码技术中的里德-所罗门算法（Reed-Solomon Code）对文件进行冗余，使用柯西矩阵作为编码矩阵。该项目参考 [Go 语言的实现的 RS 纠删码项目](https://github.com/klauspost/reedsolomon)，编写了 Go 语言代码并编译成 WebAssembly 格式，用于网页端实现文件切片和编解码。

### 监控模块

#### 监控的含义与价值

分布式监控是部署在分布式系统内的监控组件，它可以监视和显示集群中各节点的状态信息，它有运行在各个节点的进程，可以采集不同节点之间的通信消息，采集各个节点的资源利用率，最后将采集到的数据汇总到一个数据库，进行分析处理后以直观的图形化界面进行呈现。

#### Prometheus

Prometheus 是一个开源系统监控和警报工具包，它将实时的指标数据（metrics）记录并存储在通过 Http 拉取模型构建的时间序列数据库中，有着较灵活的询问功能和实时告警功能。

#### Grafana

Grafana 是一个跨平台的开源的度量分析和可视化工具，可以通过将采集的数据查询然后可视化的展示，并及时通知。

## 项目设计

### 系统架构

![image-20220702164708932](image\image-20220702164708932.png)

本项目共分为六个模块，分别是：

+ 索引服务器：与存储集群交互，获取存储节点的状态信息

+ 图数据库：维护存储文件的图结构

+ 分布式存储集群：文件切片后的存储位置
+ 分布式计算集群：由 Ray 支持的打标计算集群
+ 分布式监控：监控各模块状态、资源占用情况，可远程唤醒与关闭存储节点
+ 网页端：呈现给用户的界面，用户可进行文件或文件夹操作，查看图结构

### Neo4j

#### Neo4j 是什么

图数据库（graph database）是一个使用图结构进行查询的数据库，使用节点、边和属性来表示和存储数据。该系统的关键概念是图，它直接将存储中的数据项，与数据节点和节点间表示关系的边的集合相关联。这些关系允许直接将存储区中的数据链接在一起，并且在许多情况下，可以通过一个操作进行检索。

Neo4j 是一个高性能的 NOSQL 图形数据库。Neo4j基于其特殊的储存结构与Cypher 查询语言，设计并优化了多种图上的算法，使得查询、插入、删除等图操作的效率大大提高。我们使用 neo4j 来进行对图数据库的管理，根据标签与结点的相邻关系来进行检索，充分发挥图数据库的优势，提升文件索引的效率。

#### 改进内容

1. 同名不同类型之间文件的关联：

    DisGraFS的FILE节点只具有name和size两个有效属性,创建标签时除了来自打标的标签，还会新建一个与文件name同名的标签，可见他们也有实现这个功能的想法，但是出于种种原因未能实现。我们完成了这一点。

    我们将name拆分为name和ext，即将文件的名字和其拓展名拆分开，这使不同类型但同名文件之间的关联变得有可能（如ipadpro.pdf与ipadpro.png）

    创建与filename同名标签时 首先查询有无同名标签，若无则创建，有则跳过。然后新建关系时创建标签与文件关系即可。

2. 对路径操作的支持：

    DisGraFS的文件系统中虽然有目录结构，但是各个目录在neo4j中是一视同仁的，不能区分不同路径的同名文件。

    我们在图节点中新增了path属性，用于标识每一个文件的路径。支持了删除文件夹和重命名文件夹等路径操作。删除文件夹时通过正则匹配path属性，将path带有该前缀的节点全部删除，并适当删除孤立标签。重命名同理，通过字符串操作重新设置path属性即可。

3. 对多用户的支持：

    DisGraFS所有用户共享一个网盘。

    我们对所有节点，包括FILE和LABEL都添加了owner属性，标识该文件的所有者。在使用GraND Pro的过程中，用户的操作在图数据库里只涉及到修改自己的节点和关系。我们对前端页面查看同样做了隔离，使得所有用户都只能看到自己所有的文件和标签，从而实现GraND Pro对多用户的支持。

4. 支持更多操作：

    支持对文件进行删除，重命名，支持共享文件给其他用户。

5. 更高的执行效率：

    改进代码结构，使用更高效率的cypher查询语言命令。我们通过重新安排python代码结构及其与cypher查询语言之间的配合，提高了图数据库操作的执行效率。



### 计算集群

#### 概述

![image-20220702173343035](image\image-20220702173343035.png)

用户上传的文件，除了被切片编码发送到存储集群以外，还需要复制一份传到计算集群，计算集群检测到有新文件上传，就会执行打标操作，打标结果传给图数据库。

计算功能由 Ray cluster 支持。Ray 是一个分布式高性能计算框架，遵循了典型的 Master-Slave 的设计，Master 负责全局协调和状态维护；Slave 执行分布式计算任务。不过和传统的分布式计算系统不同的是 Ray 使用了混合任务调度的思路。

当有多个文件同时上传时，文件的打标请求会先放入任务队列，然后依次由 Ray 集群执行，Ray 为每个 Task 分配 worker，实现并行处理、负载均衡。

打标结束后，删除被打标文件。

#### 搭建 Ray cluster

Ray 的搭建需要所有节点在同一局域网内，而 Ray 的 head 节点需要保持运行，才能保证其他 worker 节点的连接，所以我们把 head 节点部署在一台服务器上，worker 节点目前位于我们本地电脑的虚拟机。局域网的实现是通过搭建 vpn，将本地接到服务器的内网。

#### 检测有新文件传到计算集群

文件接收使用 Websockets，这里使用的接收代码是更改了 dontpanic 的 client 节点的文件接收代码实现的。收到的文件存放到固定的目录下。检测由 watchdog 执行，每检测到新文件上传，就会将文件信息加入任务队列。

#### 打标操作

复用了 DisGraFS 的打标代码

#### 打标信息传给图数据库

使用到了 asyncio 库，协程遇到 IO 操作而阻塞时，立即切换到别的任务，如果操作完成则进行回调返回执行结果。实现并发执行。

### Monitor



### 前端美化

### 前端增加功能

#### 文件操作

#### 目录操作

### Storage

#### 碎片删除

用户在网页端执行删除指令后，既需要在 mysql 数据库中删除文件信息，也需要在存储节点删除对应的文件碎片。

碎片删除是一个远程操作。

### Docker

### Websockets

这里的 Websockets 特指传输文件的 Websockets，它是由 dontpanic 组实现的，不过当单词传输文件超过 20KB 后，传输就会出错。这里的原理与本课程的多人聊天室相同，问题出在 send 和 recv 操作可能一次无法全部传完，在具体代码中，体现在 read 函数，改进方法也与多人聊天室的设计思路相同，根据 read 的返回值是否与待接收消息长度相同，判断一次 read 是否真正完成。

### 用户操作

### 运维操作

## 效果展示

### 用户视角

### 运维视角

## 项目总结

## 致谢

## 参考文献
